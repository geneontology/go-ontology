# AI Agent triggered by @mentions in issues/PRs
#
# Listens for @<agent-name> please <request> mentions from authorized users
# and runs Claude Code to respond.
#
# Required secrets: ANTHROPIC_API_KEY, PAT_FOR_PR
# Configuration: .github/ai-controllers.json (list of authorized usernames)
#
# ============================================================================
# WORKFLOW PATTERN
# ============================================================================
# 1. JS step: Parse event payload, check authorization, return essentials
# 2. Claude step: Full autonomy - reads context via `gh`, makes changes,
#    pushes branches, creates PRs, posts comments directly
#
# The agent handles all git/GitHub operations itself using `gh` CLI.
#
# ============================================================================
name: AI Agent GitHub Mentions

env:
  AGENT_NAME: dragon-ai-agent
  MODEL: claude-opus-4-5-20251101
  TOOLS_DIR: ${{ github.workspace }}/tools
  ARTIFACT_RETENTION_DAYS: 90
  TIMEOUT_MINUTES: 30

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: "Issue or PR number to respond to"
        required: true
      item_type:
        description: "Type of item (issue or pull_request)"
        required: true
        type: choice
        options:
          - issue
          - pull_request
      prompt:
        description: "The request/prompt for the agent"
        required: true
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created, edited]
  pull_request:
    types: [opened, edited]
  pull_request_review_comment:
    types: [created, edited]

jobs:
  check-mention:
    runs-on: ubuntu-latest
    outputs:
      result: ${{ steps.check.outputs.result }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4        
      - name: Check for qualifying mention
        id: check
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.PAT_FOR_PR }}
          script: |
            const fs = require('fs');

            // Load allowed users from config
            let allowedUsers = [];
            try {
              const configContent = fs.readFileSync('.github/ai-controllers.json', 'utf8');
              allowedUsers = JSON.parse(configContent);
            } catch (error) {
              console.log('Error loading allowed users:', error);
              allowedUsers = ['cmungall']; // Fallback
            }

            const agentName = process.env.AGENT_NAME || 'dragon-ai-agent';

            // Handle workflow_dispatch (manual trigger)
            if (context.eventName === 'workflow_dispatch') {
              const inputs = context.payload.inputs;
              console.log(`Manual dispatch: ${inputs.item_type} #${inputs.issue_number}`);

              // Check for SKIP_ODK or "quick question" in issue body (need to fetch it)
              let skipOdk = false;
              if (inputs.item_type === 'issue') {
                try {
                  const issue = await github.rest.issues.get({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: parseInt(inputs.issue_number)
                  });
                  const body = (issue.data.body || '').toLowerCase();
                  const promptLower = inputs.prompt.toLowerCase();
                  skipOdk = body.includes('skip_odk') || body.includes('quick question') ||
                            promptLower.includes('skip_odk') || promptLower.includes('quick question');
                } catch (e) {
                  console.log('Could not fetch issue for SKIP_ODK check:', e);
                }
              }

              return {
                qualifiedMention: true,
                itemType: inputs.item_type,
                itemNumber: parseInt(inputs.issue_number),
                user: context.actor,
                prompt: inputs.prompt,
                repo: `${context.repo.owner}/${context.repo.repo}`,
                branchName: `${agentName}-${inputs.item_type}-${inputs.issue_number}-run${context.runNumber}`,
                useOdkContainer: !skipOdk,
                skipOdkNote: skipOdk ? 'NOTE: This is NOT running in the ODK container (SKIP_ODK was specified), so ODK tools like ROBOT, owltools, etc. are unavailable.' : ''
              };
            }

            // Extract essentials from event payload
            let content = '';
            let userLogin = '';
            let itemType = '';
            let itemNumber = 0;
            let commentId = null;  // For adding reaction to the triggering comment

            if (context.eventName === 'issues') {
              content = context.payload.issue.body || '';
              userLogin = context.payload.issue.user.login;
              itemType = 'issue';
              itemNumber = context.payload.issue.number;
            } else if (context.eventName === 'pull_request') {
              content = context.payload.pull_request.body || '';
              userLogin = context.payload.pull_request.user.login;
              itemType = 'pull_request';
              itemNumber = context.payload.pull_request.number;
            } else if (context.eventName === 'issue_comment') {
              content = context.payload.comment.body || '';
              userLogin = context.payload.comment.user.login;
              itemType = 'issue';
              itemNumber = context.payload.issue.number;
              commentId = context.payload.comment.id;
            } else if (context.eventName === 'pull_request_review_comment') {
              content = context.payload.comment.body || '';
              userLogin = context.payload.comment.user.login;
              itemType = 'pull_request';
              itemNumber = context.payload.pull_request.number;
              commentId = context.payload.comment.id;
            }

            // Check authorization and extract prompt
            const isAllowed = allowedUsers.includes(userLogin);
            const mentionRegex = new RegExp(`@${agentName}\\s+please\\s+(.*)`, 'is');
            const mentionMatch = content.match(mentionRegex);

            const qualifiedMention = isAllowed && mentionMatch !== null;
            const prompt = qualifiedMention ? mentionMatch[1].trim() : '';

            console.log(`User: ${userLogin}, Allowed: ${isAllowed}, Has mention: ${mentionMatch !== null}`);

            if (!qualifiedMention) {
              return { qualifiedMention: false };
            }

            // Add ðŸ‘€ reaction immediately to show we're on it
            try {
              if (commentId) {
                await github.rest.reactions.createForIssueComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: commentId,
                  content: 'eyes'
                });
              } else {
                await github.rest.reactions.createForIssue({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: itemNumber,
                  content: 'eyes'
                });
              }
              console.log('Added ðŸ‘€ reaction');
            } catch (e) {
              console.log('Could not add reaction:', e.message);
            }

            // Post "working on it" comment immediately
            try {
              const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
              const commentBody = `ðŸ¤– Working on it...\n\nFollow along: [View workflow run](${runUrl})\n\n*â€” @${agentName}*`;

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: itemNumber,
                body: commentBody
              });
              console.log('Posted "working on it" comment');
            } catch (e) {
              console.log('Could not post comment:', e.message);
            }

            // Check for SKIP_ODK or "quick question" in issue body OR the comment/content that triggered this
            let skipOdk = false;
            if (itemType === 'issue') {
              const issueBody = context.payload.issue?.body || '';
              const triggerContent = content || '';  // The comment or issue body that contained the mention
              const combined = (issueBody + ' ' + triggerContent).toLowerCase();
              skipOdk = combined.includes('skip_odk') || combined.includes('quick question');
              if (skipOdk) {
                console.log('SKIP_ODK or "quick question" found - will use ubuntu-latest instead of ODK container');
              }
            }

            // Return minimal context - Claude will use `gh` for the rest
            // Include run number in branch name to avoid collisions on concurrent runs
            return {
              qualifiedMention: true,
              itemType: itemType,
              itemNumber: itemNumber,
              user: userLogin,
              prompt: prompt,
              repo: `${context.repo.owner}/${context.repo.repo}`,
              branchName: `${agentName}-${itemType}-${itemNumber}-run${context.runNumber}`,
              useOdkContainer: !skipOdk,
              skipOdkNote: skipOdk ? 'NOTE: This is NOT running in the ODK container (SKIP_ODK was specified), so ODK tools like ROBOT, owltools, etc. are unavailable.' : '',
              commentId: commentId
            };

  respond-to-mention:
    needs: check-mention
    if: fromJSON(needs.check-mention.outputs.result).qualifiedMention == true
    timeout-minutes: 30
    permissions:
      contents: write
      pull-requests: write
      issues: write
    runs-on: ubuntu-latest
    container: ${{ fromJSON(needs.check-mention.outputs.result).useOdkContainer && 'obolibrary/odkfull:latest' || null }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          token: ${{ secrets.PAT_FOR_PR }}

      - name: Configure Git
        run: |
          git config --global user.name "${{ env.AGENT_NAME }}[bot]"
          git config --global user.email "${{ env.AGENT_NAME }}[bot]@users.noreply.github.com"

      - name: Create tools directory
        run: mkdir -p ${{ env.TOOLS_DIR }}

      - name: Add tools to PATH
        run: |
          echo "${{ env.TOOLS_DIR }}" >> $GITHUB_PATH

      - name: Add obo-scripts to PATH
        run: |
          git clone --depth 1 https://github.com/cmungall/obo-scripts.git ${{ env.TOOLS_DIR }}/obo-scripts
          echo "${{ env.TOOLS_DIR }}/obo-scripts" >> $GITHUB_PATH

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Set up GitHub token for gh CLI
        env:
          GH_TOKEN: ${{ secrets.PAT_FOR_PR }}
        run: |
          echo "GH_TOKEN=$GH_TOKEN" >> $GITHUB_ENV

      - name: Install Python tools
        run: |
          uv tool install --force oaklib
          uv tool install --force linkml-reference-validator --with linkml

      - name: Run Claude Code
        uses: anthropics/claude-code-base-action@main
        with:
          prompt: |
            You are @${{ env.AGENT_NAME }}, responding to a request from @${{ fromJSON(needs.check-mention.outputs.result).user }} on GitHub ${{ fromJSON(needs.check-mention.outputs.result).itemType }} #${{ fromJSON(needs.check-mention.outputs.result).itemNumber }}.

            ${{ fromJSON(needs.check-mention.outputs.result).skipOdkNote }}

            THE REQUEST:
            ```
            ${{ fromJSON(needs.check-mention.outputs.result).prompt }}
            ```

            GETTING CONTEXT:
            Use `gh` to read the full context. Examples:
            - `gh issue view ${{ fromJSON(needs.check-mention.outputs.result).itemNumber }} --json title,body,comments`
            - `gh pr view ${{ fromJSON(needs.check-mention.outputs.result).itemNumber }} --json title,body,comments,reviews`
            - Check for linked issues/PRs mentioned in the body

            MAKING CHANGES:
            If you need to modify files:
            1. Create a branch: `git checkout -b ${{ fromJSON(needs.check-mention.outputs.result).branchName }}`
               (unless requested to update an existing branch/PR, in which case check out and work on that branch)
            2. Make your changes and commit with descriptive messages
            3. Push the branch: `git push -u origin ${{ fromJSON(needs.check-mention.outputs.result).branchName }}`
            4. Create a PR using `gh pr create` with a clear title and description

            COMMUNICATING:
            - Use `gh` CLI directly to interact with the user on GitHub (this job runs as a GitHub Action, and users typically cannot see the chat history and response)
            - Use `gh issue comment` or `gh pr comment` to post updates
            - Always inform the user what you did (or couldn't do)
            - If you created a PR, reference it in your comment on the original issue/PR
            - If the user asked a question or asked for research, always communicate results back via `gh` rather than just in the chat
            - If you cannot complete the request, explain why in a comment on the issue/PR

            SIGNATURE:
            Always include the following signature block in (1) git commit message and (2) comments on the GitHub issue (3) comments on the GitHub PR
            ```
            ---
            ðŸ¤– **Generated by @${{ env.AGENT_NAME }}**
            - Model: `${{ env.MODEL }}`
            - Agent harness: claude-code
            - Triggered by: @${{ fromJSON(needs.check-mention.outputs.result).user }}
            - Run: [View workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            ```

          claude_args: |
            --allowedTools "Bash,Read,Write,Edit,Glob,Grep,LS,MultiEdit,NotebookEdit,TodoRead,TodoWrite,WebFetch,WebSearch"
            --model "${{ env.MODEL }}"
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          show_full_output: true

      - name: Upload Claude output
        uses: actions/upload-artifact@v4
        with:
          name: claude-response-${{ github.run_id }}
          path: /home/runner/work/_temp/claude-execution-output.json
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}
